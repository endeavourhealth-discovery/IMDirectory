<template>
  <span v-if="index === 0 && operator === Bool.or" class="either">either</span>
  <span v-else-if="index === 1 && !where.where && operator === Bool.and" style="padding-right: 1rem">with</span>
  <span v-else-if="index > 1 && !where.where && operator === Bool.and">,</span>
  <span v-else-if="operator === Bool.or" class="operator">{{ operator }}</span>
  <span v-if="where.name" class="field">{{ where.name }}</span>
  <span v-if="where.valueLabel || where.qualifier">
    <span class="value-field" v-html="getFormattedValue(where)"></span>
    <span v-if="where.relativeTo">
      <span v-if="where.relativeTo.qualifier">
        <span class="field">{{ where.relativeTo.qualifier }}</span>
      </span>
      <span class="node-ref">{{ where.relativeTo.nodeRef }}</span>
    </span>
  </span>
  <span v-if="where.nodeRef" class="node-ref">{{ where.nodeRef }}</span>
  <span v-if="expandedSet && isArrayHasLength(where.is)">
    <span>, defined as</span>
    <div>
      <span style="list-style-type: none; padding-left: 0">
        <span v-for="(item, index) in where.is" :key="index" style="padding-left: 1.5rem">
          <ul>
            <li class="tight-spacing">
              <span v-if="item.qualifier" v-html="item.qualifier"></span>
              <span class="field"> {{ item.name }}</span>
              <span v-if="item.code">({{ item.code }})</span>
              <span v-if="item.descendantsOrSelfOf">+subtypes</span>
            </li>
          </ul>
        </span>
      </span>
    </div>
  </span>

  <div v-if="isArrayHasLength(where.where)" :style="indentationStyle(depth + 1)">
    <span :class="where.operator"> {{ operator }}</span>
    <span>(</span>
    <div>
      <RecursiveWhereDisplay
        v-if="isArrayHasLength(where.where)"
        v-for="(nestedProperty, index) of where.where"
        :where="nestedProperty"
        :index="index"
        :operator="where.boolWhere"
        :key="index"
        :depth="depth + 1"
        :expandedSet="expandedSet"
      />
      <span>)</span>
    </div>
  </div>

  <RecursiveMatchDisplay v-if="where.match" :match="where.match" :depth="depth + 1" :inline="true" :index="0" :expanded="childExpand" />
</template>

<script setup lang="ts">
import { isArrayHasLength } from "@/helpers/DataTypeCheckers";
import { Where, Assignable, Bool } from "@/interfaces/AutoGen";
import { Ref, ref, watch } from "vue";
import RecursiveMatchDisplay from "./RecursiveMatchDisplay.vue";
import { IM } from "@/vocabulary/IM";

interface Props {
  where: Where;
  index: number;
  depth: number;
  operator?: Bool;
  expandedSet: boolean;
}

const props = defineProps<Props>();

const childExpand = true;

function getFormattedValue(value: Assignable) {
  let result = "";
  if (value.qualifier) {
    result = value.qualifier + " ";
  }
  if (value.valueLabel) {
    result = result + value.valueLabel;
  }
  return result;
}

function indentationStyle(depth: number) {
  return {
    marginLeft: `${depth}rem`
  };
}
</script>

<style scoped>
.tight-spacing {
  margin-top: -1rem;
  margin-bottom: 0.5rem;
  padding-left: 3rem;
}

.field {
  padding-right: 0.2rem;
}

.value-field {
  color: var(--p-green-700);
  padding-right: 0.2rem;
}

.node-ref {
  color: var(--p-amber-700) !important;
  cursor: pointer !important;
}
.or {
  color: var(--p-blue-700);
  padding-right: 0.2rem;
}

.and {
  color: var(--p-orange-700);
  padding-right: 0.3rem;
}

.property-display {
  margin-left: 0.2rem;
}
</style>
