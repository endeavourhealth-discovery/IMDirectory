/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.7.1/samples
 */
plugins {
    id 'base'
    id 'com.github.node-gradle.node'
    id "org.sonarqube" version "4.4.1.3373"
}

def sonarLogin= System.getenv('SONAR_LOGIN')

sonar {
    properties {
        property 'sonar.organization', 'endeavourhealth-discovery'
        property 'sonar.token', sonarLogin
        property 'sonar.host.url', 'https://sonarcloud.io'
        property 'sonar.projectKey', 'endeavourhealth-discovery_IM'
        property 'sonar.projectName', 'Directory'
        property 'sonar.sources', 'src'
        property 'sonar.exclusions', '**/index.ts,**/*.d.ts,**/node_modules/**'
        property 'sonar.tests', 'tests'
        property 'sonar.test.inclusions', '**/*.spec.ts,**/*.spec.js'
        property 'sonar.javascript.lcov.reportPaths', 'coverage/lcov.info'
    }
}

tasks.findByName("pnpmInstall").doNotTrackState("Otherwise fails on optional FA Pro dependency")

task pnpmBuild(type: PnpmTask) {
    dependsOn pnpmInstall
    args = ['run', 'build']
}

task pnpmTest(type: PnpmTask) {
    dependsOn pnpmInstall
    args = ['run', 'test:coverage']
}

assemble.dependsOn pnpmBuild

check.dependsOn pnpmTest

clean.doLast {
    file('coverage').deleteDir()
    file('dist').deleteDir()
}

if (env == 'prod') {
    check.finalizedBy 'sonar'
}
